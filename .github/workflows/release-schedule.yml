name: Release Schedule

on:
  schedule:
    # Scheduled for 2026-01-01 at 00:00 UTC
    - cron: '0 0 1 1 *'  # January 1st at midnight UTC
  
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., v2026.01.01)'
        required: false
        default: 'v2026.01.01'
      create_draft:
        description: 'Create as draft release'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  discussions: write

env:
  RELEASE_VERSION: v2026.01.01
  RELEASE_DATE: '2026-01-01'

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog
      
      - name: Determine release version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.release_version }}"
          else
            VERSION="${{ env.RELEASE_VERSION }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Release version: $VERSION"
      
      - name: Validate release readiness
        run: |
          echo "ðŸ” Validating release readiness..."
          
          # Check for required files
          REQUIRED_FILES=(
            "README.md"
            "LICENSE"
            "CONTRIBUTING.md"
            "SECURITY.md"
            "GOVERNANCE.md"
            "RELEASE.md"
          )
          
          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done
          
          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "âŒ Missing required files:"
            printf '  - %s\n' "${MISSING_FILES[@]}"
            echo ""
            echo "âš ï¸  Proceeding with draft release anyway..."
          else
            echo "âœ… All required files present"
          fi
          
          # Check for uncommitted changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "âš ï¸  Warning: Uncommitted changes detected"
            git status --short
          else
            echo "âœ… No uncommitted changes"
          fi
      
      - name: Generate changelog
        id: changelog
        run: |
          echo "ðŸ“ Generating changelog..."
          
          # Get list of commits since last release (or all if no previous release)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            echo "ðŸ“‹ Generating initial changelog (no previous release)"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "ðŸ“‹ Generating changelog since $LAST_TAG"
            COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Create changelog content
          cat > CHANGELOG_DRAFT.md << 'CHANGELOG_EOF'
          # Release ${{ steps.version.outputs.version }}
          
          **Release Date**: ${{ env.RELEASE_DATE }}
          
          ## Overview
          
          This release introduces comprehensive governance, DAO infrastructure, partner documentation, 
          GitAntivirus workflow enhancements, and web control panel scaffold for SmartContractAudit.
          
          ## âœ¨ New Features
          
          ### Governance Framework
          - Complete governance model and documentation
          - Contribution guidelines with DCO requirement
          - Code of Conduct (Contributor Covenant)
          - Comprehensive security policy
          - Privacy and data retention policies
          
          ### DAO Infrastructure
          - DAO documentation and governance flow
          - Contributor eligibility and scoring system
          - Merkle tree airdrop infrastructure
          - Snapshot integration documentation
          - Token claiming process documentation
          
          ### Partner Program
          - Comprehensive partner documentation
          - Tiered sponsorship structure (Supporter to Platinum)
          - Technical onboarding guides
          - SLA and support documentation
          - Use cases and success stories
          - Press kit and brand assets
          
          ### Automation & Safety
          - Enhanced GitAntivirus workflow with dry-run defaults
          - Release schedule workflow
          - Conservative repair configuration
          - Automated artifact management
          - Safety-first workflow design
          
          ### Web Control Panel
          - GitHub Pages scaffold
          - Dashboard for monitoring runs
          - Billing integration placeholder (Stripe + Cash App)
          - Documentation for publishing
          
          ### Additional Files
          - Apache-2.0 LICENSE
          - FUNDING.yml for sponsors
          - TRIO.md (Product Â· Governance Â· Security summary)
          - Resume/project overview
          - Release process documentation
          
          ## ðŸ”’ Security
          
          ### Safety Features
          - **DRY_RUN**: Enabled by default in all workflows
          - **BOT_PINGS_ENABLED**: Disabled by default
          - **ALLOWLIST_ORGS**: Empty by default (restrictive)
          - **Permissions**: Minimal required permissions only
          
          ### Security Practices
          - No secrets included in any files
          - All destructive operations require explicit opt-in
          - Workflows run in dry-run mode unless overridden
          - Write operations require scoped GitHub token or App
          - Manual approval required for releases
          
          ## ðŸ“š Documentation
          
          - 10 top-level governance files
          - 6 DAO documentation files
          - 9 partner documentation files
          - Complete technical onboarding guide
          - Release process documentation
          
          ## ðŸ› ï¸ Developer Experience
          
          - Availability checker script for handle/package names
          - Merkle tree generator for airdrops
          - Sample DAO allocation data
          - Executable scripts with proper permissions
          
          ## âš ï¸ Breaking Changes
          
          None. This release is additive and does not modify existing functionality.
          
          ## ðŸ“¦ Installation
          
          ```bash
          git clone https://github.com/SolanaRemix/SmartContractAudit.git
          cd SmartContractAudit
          ```
          
          ## ðŸš€ Getting Started
          
          1. Review the [README.md](README.md)
          2. Read [CONTRIBUTING.md](CONTRIBUTING.md) to contribute
          3. Check [SECURITY.md](SECURITY.md) for security practices
          4. Explore [docs/](docs/) for comprehensive documentation
          5. See [GOVERNANCE.md](GOVERNANCE.md) for project governance
          
          ## ðŸ“‹ Requirements
          
          - Git 2.x+
          - Node.js 20+ (for JavaScript tools)
          - GitHub account
          - Basic command-line knowledge
          
          ## ðŸ¤ Contributing
          
          We welcome contributions! Please see:
          - [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines
          - [docs/dao/](docs/dao/) for DAO participation
          - [docs/partners/](docs/partners/) for partnership opportunities
          
          ## ðŸ’¬ Community
          
          - **GitHub Issues**: Bug reports and features
          - **GitHub Discussions**: Community Q&A
          - **Security**: security@cuberai.example
          - **Partners**: partners@cuberai.example
          
          ## ðŸ“œ License
          
          Apache-2.0 - See [LICENSE](LICENSE) for details
          
          ## ðŸ™ Acknowledgments
          
          Thank you to all contributors and supporters who made this release possible!
          
          ---
          
          **Note**: This is a DRAFT release. Final deployment requires manual approval.
          
          For detailed changes, see the commit history:
          https://github.com/SolanaRemix/SmartContractAudit/commits/${{ steps.version.outputs.version }}
          CHANGELOG_EOF
          
          # Output for use in release notes
          CHANGELOG_CONTENT=$(cat CHANGELOG_DRAFT.md)
          echo "changelog<<CHANGELOG_DELIMITER" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "CHANGELOG_DELIMITER" >> $GITHUB_OUTPUT
          
          echo "âœ… Changelog generated"
      
      - name: Upload changelog
        uses: actions/upload-artifact@v3
        with:
          name: release-changelog
          path: CHANGELOG_DRAFT.md
          retention-days: 30

  create-draft-release:
    name: Create Draft Release
    runs-on: ubuntu-latest
    needs: prepare-release
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create draft release
        id: create_release
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.prepare-release.outputs.version }}';
            const isDraft = '${{ github.event.inputs.create_draft || 'true' }}' === 'true';
            
            console.log(`Creating ${isDraft ? 'draft' : 'public'} release ${version}`);
            
            try {
              const release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: version,
                name: `SmartContractAudit ${version}`,
                body: `# SmartContractAudit ${version}
            
            **Release Date**: ${{ env.RELEASE_DATE }}
            **Status**: ${isDraft ? 'DRAFT - Pending Manual Approval' : 'Released'}
            
            ## ðŸŽ‰ Highlights
            
            This release introduces comprehensive governance, DAO infrastructure, partner program, and enhanced security workflows.
            
            ### Key Features
            - âœ… Complete governance framework
            - âœ… DAO infrastructure and documentation
            - âœ… Partner program with 5 tiers
            - âœ… GitAntivirus safe workflow (dry-run by default)
            - âœ… Web control panel scaffold
            - âœ… Apache-2.0 license
            
            ### Security
            - ðŸ”’ DRY_RUN enabled by default
            - ðŸ”’ No secrets included
            - ðŸ”’ Non-destructive operations
            - ðŸ”’ Manual approval required
            
            ## ðŸ“š Documentation
            
            Complete documentation for:
            - Governance and contribution
            - DAO participation and airdrops
            - Partner program and sponsorship
            - Security and privacy policies
            - Technical onboarding
            
            ## âš ï¸ Important Notes
            
            **This is a ${isDraft ? 'DRAFT' : ''} release and requires:**
            - Manual review and approval before deployment
            - Testing in non-production environment
            - Security review completion
            - Community announcement coordination
            
            **Do NOT deploy to production without:**
            1. Complete security review
            2. Testing all new features
            3. Backup of current state
            4. Approval from maintainers
            
            ## ðŸ“¦ What's Included
            
            See full changelog in workflow artifacts or commit history for details.
            
            ## ðŸš€ Getting Started
            
            \`\`\`bash
            git clone https://github.com/SolanaRemix/SmartContractAudit.git
            cd SmartContractAudit
            git checkout ${version}
            \`\`\`
            
            ## ðŸ†˜ Support
            
            - **Issues**: GitHub Issues
            - **Security**: security@cuberai.example
            - **Partners**: partners@cuberai.example
            
            ---
            
            *For detailed release checklist, see [RELEASE.md](RELEASE.md)*
            `,
                draft: isDraft,
                prerelease: false,
                target_commitish: context.sha
              });
              
              console.log(`âœ… Release created: ${release.data.html_url}`);
              core.setOutput('release_url', release.data.html_url);
              core.setOutput('release_id', release.data.id);
              
              return release.data;
            } catch (error) {
              if (error.message.includes('already_exists')) {
                console.log('â„¹ï¸  Release already exists');
                // Try to get existing release
                const { data: releases } = await github.rest.repos.listReleases({
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
                const existingRelease = releases.find(r => r.tag_name === version);
                if (existingRelease) {
                  console.log(`â„¹ï¸  Found existing release: ${existingRelease.html_url}`);
                  core.setOutput('release_url', existingRelease.html_url);
                  core.setOutput('release_id', existingRelease.id);
                }
              } else {
                throw error;
              }
            }
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“¦ Release Creation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.prepare-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: DRAFT (Manual approval required)" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: ${{ env.RELEASE_DATE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Next Steps Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Review draft release on GitHub" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Complete security review" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Test all features" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… Get maintainer approval" >> $GITHUB_STEP_SUMMARY
          echo "5. âš ï¸ Manually publish release when ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Security Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] All tests passing" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Security scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] No secrets in codebase" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Documentation reviewed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Dry-run defaults confirmed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL**: Check workflow outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*This workflow creates DRAFT releases only. Manual approval required for publishing.*" >> $GITHUB_STEP_SUMMARY
