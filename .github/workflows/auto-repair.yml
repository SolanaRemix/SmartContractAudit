name: Auto-Repair

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to fix'
        required: false
      scan_report:
        description: 'Path to scan report'
        required: false

jobs:
  auto-repair:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.label.name == 'auto-fix'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Get issue details
        if: github.event_name == 'issues'
        id: issue
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            return {
              number: issue.number,
              title: issue.title,
              body: issue.body
            };
      
      - name: Generate fixes
        id: fix
        run: |
          # Check if there's a recent scan report
          if [ -f "reports/latest.json" ]; then
            echo "Using latest scan report"
            node script/repair.js --report reports/latest.json --source contracts/ > repair.log 2>&1
            echo "result=$?" >> $GITHUB_OUTPUT
          else
            echo "No scan report found"
            echo "result=1" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "reports/fixes.json" ]; then
            FIX_COUNT=$(jq 'length' reports/fixes.json)
            echo "fix_count=$FIX_COUNT" >> $GITHUB_OUTPUT
          else
            echo "fix_count=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Apply fixes to code
        if: steps.fix.outputs.fix_count > 0
        run: |
          echo "Applying ${{ steps.fix.outputs.fix_count }} fixes..."
          # This would apply the generated patches
          # For now, just log what would be done
          cat reports/fixes.json
      
      - name: Create Pull Request
        if: steps.fix.outputs.fix_count > 0
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto-fix-${{ github.run_number }}
          commit-message: 'üîí Automated security fixes'
          title: 'üîí Automated Security Fixes'
          body: |
            ## Automated Security Fixes
            
            This PR contains automated fixes for detected security vulnerabilities.
            
            ### Fixed Issues
            
            Applied ${{ steps.fix.outputs.fix_count }} automated fix(es).
            
            ### Review Checklist
            
            - [ ] Review all code changes
            - [ ] Run tests to ensure functionality
            - [ ] Verify security improvements
            - [ ] Check for any breaking changes
            
            ### Related Issue
            
            ${{ github.event_name == 'issues' && format('Fixes #{0}', github.event.issue.number) || 'Manual trigger' }}
            
            ---
            
            ‚ö†Ô∏è **Important:** Please carefully review these automated changes before merging.
            While these fixes address known vulnerabilities, they should be tested thoroughly.
            
            *Generated by Auto-Repair Workflow*
          labels: security, automated-fix, needs-review
          assignees: ${{ github.event.issue.assignees && join(github.event.issue.assignees.*.login, ',') || '' }}
          reviewers: ${{ github.repository_owner }}
      
      - name: Comment on issue
        if: github.event_name == 'issues' && steps.fix.outputs.fix_count > 0
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ Automated fixes have been generated and a pull request has been created. Please review the PR for the proposed changes.'
            });
      
      - name: Comment on issue if no fixes
        if: github.event_name == 'issues' && steps.fix.outputs.fix_count == 0
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚ö†Ô∏è Unable to generate automated fixes for this issue. Manual review and fixes may be required.'
            });
